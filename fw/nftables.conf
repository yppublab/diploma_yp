table inet fw {
  set users_net {
    type ipv4_addr;
    flags interval;
    elements = { 192.168.202.0/24, 10.97.23.0/24 }
  }
  set servers_net {
    type ipv4_addr;
    flags interval;
    elements = { 192.168.201.0/24 }
  }
  set infosec_net {
    type ipv4_addr;
    flags interval;
    elements = { 192.168.203.0/24 }
  }
  set dmz_net {
    type ipv4_addr;
    flags interval;
    elements = { 192.168.204.0/24 }
  }
  set admin_net {
    type ipv4_addr;
    flags interval;
    elements = { 192.168.205.0/24 }
  }
  set dev_net {
    type ipv4_addr;
    flags interval;
    elements = { 192.168.206.0/24 }
  }
  set internal_nets {
    type ipv4_addr;
    flags interval;
    elements = {
      192.168.201.0/24,
      192.168.202.0/24,
      192.168.203.0/24,
      192.168.204.0/24,
      192.168.205.0/24,
      192.168.206.0/24,
      10.97.23.0/24,
      10.97.24.0/24,
      10.97.25.0/24,
      10.97.26.0/24
    }
  }
  set uplink_net {
    type ipv4_addr;
    flags interval;
    elements = { 172.56.200.0/24 }
  }
  set admin_infosec_nets {
    type ipv4_addr;
    flags interval;
    elements = { 192.168.205.0/24, 192.168.203.0/24 }
  }
  set user_admin_infosec_nets {
    type ipv4_addr;
    flags interval;
    elements = { 192.168.202.0/24, 192.168.205.0/24, 192.168.203.0/24, 10.97.23.0/24 }
  }

  set srv_dns { type ipv4_addr; elements = { 192.168.201.24 } }
  set srv_ntp { type ipv4_addr; elements = { 192.168.201.123 } }
  set srv_ldap { type ipv4_addr; elements = { 192.168.201.199 } }
  set srv_fs { type ipv4_addr; elements = { 192.168.201.33 } }
  set srv_wiki { type ipv4_addr; elements = { 192.168.201.120 } }
  set srv_espocrm { type ipv4_addr; elements = { 192.168.201.215 } }
  set srv_espocrm_db { type ipv4_addr; elements = { 192.168.201.216 } }
  set srv_polarproxy { type ipv4_addr; elements = { 192.168.204.204 } }
  set srv_web { type ipv4_addr; elements = { 192.168.204.34 } }
  set srv_wg_portal { type ipv4_addr; elements = { 192.168.204.200 } }
  set srv_arkime { type ipv4_addr; elements = { 192.168.203.53 } }
  set srv_opensearch { type ipv4_addr; elements = { 192.168.203.55 } }
  set srv_wazuh_manager { type ipv4_addr; elements = { 192.168.203.88 } }
  set srv_wazuh_indexer { type ipv4_addr; elements = { 192.168.203.89 } }
  set srv_wazuh_dashboard { type ipv4_addr; elements = { 192.168.203.90 } }
  set srv_ldap_mgr { type ipv4_addr; elements = { 192.168.205.199 } }

  chain input {
    type filter hook input priority 0;
    policy drop;
    ct state established,related accept
    iifname "lo" accept
    ip protocol icmp accept
    ip saddr @admin_infosec_nets tcp dport 22 accept
  }

  chain forward {
    type filter hook forward priority 0;
    ct state established,related accept
    policy drop;
    ct status dnat accept
    ip protocol icmp accept
    # Почта
    ip daddr 192.168.201.50 tcp dport 25 counter accept

    # DNS
    ip saddr @internal_nets ip daddr @srv_dns udp dport 53 accept
    ip saddr @internal_nets ip daddr @srv_dns tcp dport 53 accept

    # NTP
    ip saddr @internal_nets ip daddr @srv_ntp udp dport 123 accept

    # LDAP
    ip saddr @internal_nets ip daddr @srv_ldap tcp dport 389 accept

    # LDAP manager
    ip saddr @user_admin_infosec_nets ip daddr @srv_ldap_mgr tcp dport 80 accept

    # RDP from bastions/admins to user PCs
    ip saddr @admin_infosec_nets ip daddr @users_net tcp dport 3389 accept
    ip saddr @admin_infosec_nets ip daddr @users_net udp dport 3389 accept
    ip saddr @users_net ip daddr @users_net udp dport 3389 accept

    # SSH administration
    ip saddr @internal_nets ip daddr @internal_nets tcp dport 22 accept

    # SMB to file server
    ip saddr @user_admin_infosec_nets ip daddr @srv_fs tcp dport { 445, 139 } accept
    ip saddr @user_admin_infosec_nets ip daddr @srv_fs udp dport { 137, 138 } accept

    # Web services
    ip saddr @user_admin_infosec_nets ip daddr @srv_web tcp dport { 80, 8080 } accept
    ip saddr @user_admin_infosec_nets ip daddr @srv_wiki tcp dport 80 accept
    ip saddr @user_admin_infosec_nets ip daddr @srv_espocrm tcp dport 80 accept
    ip saddr @srv_espocrm tcp dport 3306 accept
    ip saddr @srv_web ip daddr @srv_espocrm_db tcp dport 3306 accept    

    # PolarProxy and Arkime   
    ip saddr @srv_polarproxy ip daddr @srv_arkime tcp dport 57012 accept
    ip saddr @infosec_net ip daddr @srv_arkime tcp dport 8005 accept
    ip saddr @srv_arkime ip daddr @srv_opensearch tcp dport 9200 accept

    # Wazuh
    ip saddr @internal_nets ip daddr @srv_wazuh_manager tcp dport { 1514, 1515 } accept
    ip saddr @srv_wazuh_dashboard ip daddr @srv_wazuh_manager tcp dport 55000 accept
    ip saddr @srv_wazuh_manager ip daddr @srv_wazuh_indexer tcp dport 9200 accept
    ip saddr @srv_wazuh_dashboard ip daddr @srv_wazuh_indexer tcp dport 9200 accept
    ip saddr @admin_infosec_nets ip daddr @srv_wazuh_dashboard tcp dport 5601 accept

    # WireGuard portal
    ip saddr @admin_infosec_nets ip daddr @srv_wg_portal tcp dport { 8888, 8787 } accept
    iifname "eth_uplink" ip daddr @srv_wg_portal udp dport 51820 counter accept
    ip saddr @srv_wg_portal ip daddr @internal_nets counter accept

    # API ingress from uplink
    iifname "eth_uplink" ip daddr 192.168.204.93 tcp dport 8080 counter accept

    # Web ingress from uplink
    iifname "eth_uplink" ip daddr 192.168.204.34 tcp dport { 80, 443, 8080 } counter accept

    # Egress to internet from internal segments
    ip saddr @internal_nets oifname "eth_uplink" accept

    counter drop
  }

  chain output {
    type filter hook output priority 0; policy accept;
  }
}

table ip nat {
  chain PREROUTING {
    type nat hook prerouting priority -100;
    iifname "eth_uplink" tcp dport 25 counter dnat to 192.168.201.50
    # WEB & API ingress to srv_web
    ip daddr 172.56.200.100 tcp dport { 80, 443, 8080 } counter dnat to 192.168.204.34
    ip daddr 172.56.200.100 udp dport { 80, 443, 8080 } counter dnat to 192.168.204.34
    ip daddr 172.56.200.100 udp dport 51820 counter dnat to 192.168.204.200:51820

    # Правила, позволяющие вам подключаться напрямую к бастиону ИБ и вашему компьютеру 
    # Считаем что этих правил не существует
    ip daddr 172.56.200.100 tcp dport 22 counter dnat to 192.168.203.66:22
    ip daddr 172.56.200.100 tcp dport 33389 counter dnat to 192.168.202.242:3389    
    ip daddr 172.56.200.100 tcp dport 43389 counter dnat to 192.168.203.66:3389
  }

  chain POSTROUTING {
    type nat hook postrouting priority 100;
    oifname "eth_uplink" masquerade  # Generic egress to inet
  }
}
